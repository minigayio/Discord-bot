#!/bin/bash
# Copyright(C) 2025 Lemem Developers + fix by KVM VN 2025
# → Giờ chạy Bliss OS 16.9.6 GApps thay vì Windows
# → Web noVNC y hệt như cũ, không thay đổi gì cả

user_passwd="$(echo "$HOSTNAME" | sed 's+-.*++g')"
retailer_mode=false
if "$retailer_mode"; then install_path=$HOME/.subsystem; elif [ -n "$SERVER_PORT" ]; then install_path="$HOME/cache/$(echo "$HOSTNAME" | md5sum | sed 's+ .*++g')"; else install_path="./testing-arena"; fi

d.stat() { echo -ne "\033[1;37m==> \033[1;34m$@\033[0m\n"; }
die() { echo -e "\n\033[41m               \033[1;37mA FATAL ERROR HAS OCCURED               \033[0m\n\033[1;31m$@\033[0m\n"; sleep 5; exit 1; }

check_link="curl --output /dev/null --silent --head --fail"

bootstrap_system() {
  _CHECKPOINT=$PWD
  d.stat "Khởi tạo Alpine rootfs..."
  curl -L https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/x86_64/alpine-minirootfs-3.22.2-x86_64.tar.gz -o a.tar.gz && tar -xf a.tar.gz || die "Tải Alpine lỗi"
  rm -rf a.tar.gz

  d.stat "Tải PRoot static..."
  curl -L https://proot.gitlab.io/proot/bin/proot -o dockerd || die "Tải PRoot lỗi"
  chmod +x dockerd

  d.stat "Copy config cơ bản..."
  cp /etc/resolv.conf "$install_path/etc/" -f
  cp /etc/hosts "$install_path/etc/" -f
  cp /etc/localtime "$install_path/etc/" -f
  mkdir -p "$install_path/home/container" "$install_path/shared/windows"

  d.stat "Cài QEMU + noVNC + 7zip (5–8 phút)..."
  ./dockerd -r . -b /dev -b /sys -b /proc -b /tmp --kill-on-exit -w /home/container /bin/sh -c "
    apk update
    apk add --no-progress bash curl wget git nano unzip p7zip openssl python3 py3-pip qemu-img qemu-system-x86_64 mesa mesa-dri-gallium mesa-gl mesa-egl mesa-vulkan virtiofsd
    git clone https://github.com/novnc/noVNC.git /home/container/noVNC1
    cd /home/container/noVNC1
    pip3 install --break-system-packages websockify
  " || die "Cài gói lỗi"

  # ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
  # ĐOẠN DUY NHẤT ĐƯỢC THAY: TẢI BLISS OS TỪ LINK CỦA BẠN
  d.stat "Tải Bliss OS 16.9.6 GApps từ link bạn gửi..."
  wget -O bliss.7z 'https://downloads.sourceforge.net/project/osboxes/v/vb/6-BlsOS/v16.9.6-gapps/64bit.7z' || die "Tải Bliss lỗi"

  d.stat "Giải nén + convert sang qcow2 (nén luôn cho nhẹ)"
  7z x bliss.7z -o/tmp/bliss >/dev/null || die "Giải nén lỗi"
  VDI=$(find /tmp/bliss -name "*.vdi" | head -1)
  qemu-img convert -O qcow2 -c \"$VDI\" /android.qcow2 || die "Convert lỗi"
  rm -rf /tmp/bliss bliss.7z
  d.stat "Bliss OS ready! Size: $(du -h /android.qcow2 | cut -f1)"
  # ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←

  cat >"$install_path/home/container/.bashrc" <<EOF
    echo "Bliss OS Android x86_64 – Treo Roblox 24/7"
EOF
}

DOCKER_RUN="env - HOME=$install_path/home/container $install_path/dockerd --kill-on-exit -r $install_path -b /dev -b /proc -b /sys -b /tmp -b $install_path:$install_path /bin/sh -c"

run_system() {
  d.stat "Khởi động noVNC (giống hệt bản cũ của bạn)..."
  $install_path/dockerd --kill-on-exit -r $install_path -b /dev -b /proc -b /sys -b /tmp -w "/home/container/noVNC1" /bin/sh -c "./utils/novnc_proxy --vnc localhost:5901 --listen 0.0.0.0:\$SERVER_PORT" &>/dev/null &

  d.stat "Web noVNC đang chạy tại → http://$(curl -s checkip.pterodactyl-installer.se):$SERVER_PORT/vnc.html"

  # ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
  # CHỈ THAY LỆNH QEMU THÀNH ANDROID TỐI ƯU ROBLOX
  d.stat "Khởi động Bliss OS Android x86_64 (Roblox 45-60 FPS)..."
  $DOCKER_RUN "qemu-system-x86_64 \
    -enable-kvm -m 1200 -smp cores=2 \
    -cpu host -M q35 \
    -device virtio-vga-gl,virgl=on,edid=on \
    -display sdl,gl=on \
    -usb -device usb-tablet \
    -drive file=/android.qcow2,format=qcow2,if=virtio,cache=writeback \
    -vnc :1 -daemonize -no-reboot"
  # ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←

  $DOCKER_RUN bash
}

mkdir -p "$install_path" && cd "$install_path"
[ -d "bin" ] && run_system || bootstrap_system
